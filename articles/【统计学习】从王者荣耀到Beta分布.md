**写在前面**：笔者最近再看Thompson sampling算法，里面提到了Beta分布，之前笔者对此只是粗读，不求甚解，趁此机会特意深入学习一下，于是就有了这篇文章。

## 1 菜鸡or大佬？

众所周知，王者荣耀是一款5v5多人运动，如今风头正盛，无论是马路边、教室里，或是办公室经常时不时传出一句“欢迎来到王者峡谷...全军出击...”。笔者也深陷其中，不能自拔。。。作为一个打工人，笔者严格践行着爱岗敬业的社会主义核心价值观，只能在夜深人静&女票不在的时候熬夜开两把，，，**LJ农药，还我头发！**

赛季快结束了，笔者也顺利上了王者，看了看战绩，胜率60%，好像还阔以，哈哈哈哈似乎是个大佬。但是由于王者荣耀独特的elo机制，玩家每场对局胜率被控制在50%左右，再加上积分保星的机制，只要你足够肝，总可以上王者，这类肝积分的玩家也被称为“积分战神”。

究竟是菜鸡（积分战神）还是大佬，还需要其他数据来证明，比如MVP次数，MVP是most valuable player的缩写，表示对胜利最有贡献的玩家。为了证明笔者是个大佬，笔者捞出了当前赛季的战绩：总场数（125）、胜率（60%）、MVP（45）。

光从MVP获取次数看，这个战绩到底是啥水平？

笔者搜了一些相关文章，关于每100场中mvp获取次数与玩家实力的关系总结如下：

- <15次，即使你是王者，也只是一个躺赢选手，你不能掌控胜负，逆风无力。

- 20次左右，这是一个正常参数，1/5的几率，水平中庸，偶尔有发光点，但输赢也需要靠队友。

- 30次-40次，说明你的水平可以掌控一定的局面队里的核心！

- 50次以上，当前段位，你是1v9的神！

也就是说**抛开段位，我们可以简单采用mvp率指标来衡量玩家实力**。我们把玩家在每场比赛中获得MVP的可能性叫做MVP率，所以MVP率应该是一个0到1之间的数。通常认为平均的MVP率是0.2，如果能达到0.3就有一定的Carry能力了。

## 2 二项分布

现在假定笔者的MVP率就是38%（45/125），在笔者实力不变的情况下，如果想知道下个赛季前100场比赛中获取50次mvp的概率是多少应该怎么计算？这个显然难不倒大家，根据假设笔者实力不变，所以接下来每场比赛笔者获取MVP的概率都是38%，前100场比赛可以看作100次独立重复伯努利实验，那么笔者获取MVP次数的概率是服从**二项分布**的。

统计学家们总结出了**二项分布**计算概率的一般公式：
$$
b(k,n,p) = C^k_n p^k (1-p)^{n-k}
$$
式中$C^k_n$表示从n个元素中取k个元素的组合数，具体地，$c^k_n = \frac {n!}{(n-k)!k!}$。

所以想知道笔者下个赛季前100场比赛中获取50次mvp的概率，套用上述公式计算$b(50,100,0.38)$的值即可。

## 3 Beta分布

现在笔者买了一张战绩清零卡，把前面所有战绩全部清零（别笑，在农药里，这是积分战神的常规操作emmmm。。。），这时候如何预测笔者的MVP率呢？

你可能要说，直接计算MVP率，用获得MVP的次数除以总场次，但是如果笔者战绩清零后只打了一场，而且还获得了MVP，那么笔者的MVP率就是100%了，这显然是不合理的，因为根据历史统计数据，我们知道正常业余玩家这个MVP率应该是0.2到0.4之间才对啊，明显会误判了笔者的水平。反之，假如笔者在最开始的几场频失利没有获取MVP，这可能意味着笔者的MVP率会稍稍低于平均水平，但是不会偏离这个范围太远，直接说笔者是MVP率为0%的菜鸡可不行！

看出问题了吗？实际问题里mvp率不能直接靠统计当前战绩来获取，还需要一些历史信息比如大多数人的MVP率是多少（先验知识），结合先验知识和实验数据（当前战绩）才能更好地预测mvp率（后验分布）。
$$
先验分布+实验数据 \rightarrow 后验分布
$$
对于这个问题，一个最好的方法用来表示这些先验知识，就是用Beta分布，这表示在笔者战绩清零后第一场比赛之前，我们对笔者的mvp率值就有了一个大概的范围。beta分布的定义域是$(0,1)$这就跟概率的范围是一样的。具体Beta函数公式如下：
$$
B(\alpha, \beta) = \int ^1_0 {x^{\alpha -1}(1-x)^{\beta -1}}dx,\quad 其中\alpha,\beta  >0
$$
对Beta函数做个变形，可以得到如下式子:
$$
1 = \int ^1_0 {\frac {x^{\alpha -1}(1-x)^{\beta -1}}{B(\alpha, \beta)}}dx
$$
得到了Beta分布的密度函数:
$$
B(x|\alpha, \beta) = \frac {x^{\alpha -1}(1-x)^{\beta -1}}{B(\alpha, \beta)}
$$
可以发现Beta分布的归一化常数（使得Beta值为1的点）恰为Beta函数在$\alpha,\beta$处的值。

Beta 分布的期望$E=\frac{\alpha}{\alpha+\beta}$、方差$D=\frac{\alpha\beta}{(\alpha+\beta)^2(\alpha+\beta+1)}$

总算把公式抄完了，mmp这么复杂，来把农药压压惊。。。

打完了说正事，相信很多童鞋有疑问：说了这么半天，先验知识跟Beta分布有毛线关系？别急慢慢来。。。

我们预期笔者一个赛季的mvp率大约是30%，在0.2到0.4之间都是合理的。这种情况可以用一个参数$\alpha = 30$和$\beta = 70$的Beta分布来表示，画一下Beta分布图：

```python
import numpy as np
from scipy.stats import beta
from matplotlib import pyplot as plt

a, b = 30, 70
x = np.linspace(0, 1, 1002)[1:-1]
fig, ax = plt.subplots(figsize=(14,9))
plt.plot(x, beta.pdf(x, a, b), c='tab:blue',label=r'$\alpha=%.1f,\ \beta=%.1f$' % (a, b))

plt.xlim(0, 1)
plt.ylim(0, 10)
plt.legend()
```

![beta(30,70)](https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5rvx4hIMKaaPZmI0Fx8tpvA6fIRMqDgtN5rHMnlmvQ2VpJiaic2WHU8OlRzlib1lqKQ6YWNPFGhteZlQ/0?wx_fmt=png)

出于以下两个原因笔者选择了这两个参数：

- 平均数（期望）是$\alpha/(\alpha + \beta)=30/(30+70)=0.3$

- 从图中你就可以看出来，这个分布几乎全部分布在$(0.2,0.4)$这个范围之间，也就是mvp率的合理范围。

（关于参数的选取，可以参考：http://stats.stackexchange.com/questions/47916/bayesian-batting-average-prior/47921#47921）

在这个Beta分布概率密度图中，x轴代表的是mvp率，y轴是概率密度（相当于概率的导数）。上图这个Beta分布实际表示了mvp率的先验知识。

如何把先验知识和实验数据结合起来呢？想象一下如果笔者战绩清零后打了一场同时拿到了MVP，那么笔者在本赛季的记录就是“获得MVP一次，比赛一次”。这个时候如果要估计笔者的MVP率，就需要更新我们的Beta分布——将整个曲线稍稍移动一点来反映我们刚刚得到的信息。新的Beta分布如下：
$$
Beta (\alpha _0+获取mvp次数,\beta _0+未获取mvp次数)
$$
其中$\alpha _0$和$\beta _0$是初始参数，即30和70。因此在上述情况下，$\alpha$增加1，$\beta$不变，也就是我们新的Beta分布为$Beta(30+1,70)$。让我们和之前的图像做个比较：

![beta(31,70)](https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5rvx4hIMKaaPZmI0Fx8tpvAKd2ICFywZUKWZq0Vus23YbFfzoxYicvt9CLOGib3EzUx7wwqTSoKicmeQ/0?wx_fmt=png)

可以看到有一丢丢右移，几乎没什么变化，因为这只一次比赛说明不了什么。

然而，随着笔者在本赛季获得MVP次数增加，这条曲线就会不断偏移调整来拟合新的信息，并且当我们的信息越多，基于实际情况调整后的曲线就会越窄越高。假设到赛季中期，笔者已经参加排位赛125次，其中45次获得MVP（目前赛季的数据）。新的分布就是$Beta(30+45,70+80)$：

![beta(75,150)](https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5rvx4hIMKaaPZmI0Fx8tpvAjmicKMibJvR0P4h3xibQCaZAicxG7PTSQcccRZVjZqeWT5yicl39msdk2kQ/0?wx_fmt=png)

可以看到，跟以前相比，曲线现在变得更“瘦”了，并且向右移动了，现在我们对于笔者的mvp率有了更好的感受。

**为啥beta分布会变瘦？**

比赛场次多了，相当于重复实验多了，估计的概率就会越来越靠谱，概率密度也会越来越集中。

**为啥beta分布会右移？**

先前因为没有笔者的比赛记录，所以先验知识使用的是业余玩家平均水平（百场获得30次mvp），而笔者的实力高于普通玩家，所以mvp率的期望值变大，反映在图像上就是右移。

我们最感兴趣的结果就是Beta分布的期望，也就是先验知识结合实验数据后的最新估计。复习一下，Beta分布的期望值是$\alpha/(\alpha + \beta)$。因此，在125场比赛获取45次MVP的情况下，新的Beta分布的期望值就是$(30+45)/(30+70+125)=0.333$，比单纯计算概率来估计mvp率的方法$45/(125)=0.38$要低，但是比一开始根据玩家平均水平所做的预测30%要高。其实这种方法相当于先将玩家平均水平赋予笔者——也就是让笔者以百场获得30次mvp来作为本赛季的初始数据。

可以看到，Beta分布是表示概率的概率分布的最佳方式——我们可能无法提前知道一件事的概率，但是我们可以根据先验知识做一些合理的猜测，在实践中不断修正咱们的猜测。

写到这里，聪明的你也发现了，$\beta $分布与二项分布的关系是：

- 二项分布是给定事件概率，估计出现的次数。
- $\beta $分布是给定了出现的次数，估计给定事件的概率。实际上，这背后的原理还有一个更加深层次的解释:那就是$\beta $分布是二项分布的**共轭先验**

## 4 共轭先验

还是那个假设笔者实力不变，估计笔者mvp率的问题。

好了，现在笔者战绩清零后打了$n$个赛季了，那么进行到此时这个mvp率应该估计为多少比较好呢？

为此，我们使用$\beta $分布解决这个问题，这样一来我们就得到了当前最新的mvp率估计。但是我们还是要继续打比赛的，于是笔者夜深人静瞒着女票开始了第$n+1$个赛季的奋战。

现在我们想知道的是，刚才的最新的mvp率估计到底靠不靠谱呢？于是我们在假定这个mvp率正确的情况下，来猜一猜笔者第$n+1$个赛季里，获取多少次mvp比较有可能呢？

为此，我们使用二项分布来解决这个问题，这样一来我们就得到了当前最新的mvp率估计。但是我们还是要继续打比赛的，于是笔者夜深人静瞒着女票开始了第$n+2$个赛季的奋战哦……这是一个无穷尽的过程，随着笔者比赛场次的增多，我们最终可以让mvp率的估计越来越靠谱。这个迭代的过程，我们刚才的表述中已经无比清晰地向我们展现了如下的关系：
$$
\beta 分布 \propto 二项分布 \times \beta 分布
$$
上面这个式子两个$\beta $分布无非就是参数不同而已，但都是$\beta $分布。

在贝叶斯理论中，我们把等式左侧的部分叫做**后验概率**，等式右侧第一项叫做**似然**，第二项叫做**先验概率**。贝叶斯理论认为：$后验概率 \propto 似然 \times 先验概率$。

而在我们的这个场景中，我们发现，这里的后验概率与先验概率遵循同样的分布律。我们把这种情况叫做共轭。即:

- 此时的先验概率和后验概率互为共轭。
- 此时的先验概率叫做似然的**共轭先验**。

看到这里有些童鞋要问了，你特么上面的公式怎么来的？这里做下简单解释。

假设前面$n$个赛季估计出的笔者的mvp率为$p$，那么

二项分布（似然）：
$$
P(data|p) \propto p^k (1-p)^{n-k}
$$
$\beta$分布（先验概率）：
$$
B(\alpha, \beta) \propto p^{\alpha -1}(1-p)^{\beta -1}
$$
后验概率：
$$
P(p|data) = \frac {P(data|p) P(p)}{P(data)} \propto P(data|p) P(p)
$$
注意到因为$P(data)$与我们所需要估计的$p$是独立的，因此我们可以不考虑它。
$$
P(p|data) \propto P(data|p) P(p) \propto p^{\alpha +k -1}(1-p)^{\beta +n-k -1}
$$
令$\alpha ^{\prime} = \alpha +k,\beta ^{\prime} =\beta +n-k$，可以看出后验概率还是$\beta$分布：
$$
P(p|data) = \frac {p^{\alpha ^{\prime} -1}(1-p)^{\beta ^{\prime} -1}}{B(\alpha ^{\prime}, \beta ^{\prime})}\propto p^{\alpha ^{\prime} -1}(1-p)^{\beta ^{\prime} -1}
$$
行了，还看不懂就去农药两把压压惊。。。

## 5 小结

这篇文章从王者荣耀战绩出发，详细解释了二项分布、$\beta$分布的概念以及两者之间的关系，希望对大家有用。

