## 1 概念背景
### 1.1 什么是探索性数据分析

探索性数据分析（Exploratory Data Analysis，EDA）是由统计学家图基提出的一个概念，指的是在没有先验的假设或者很少的假设的情况下，数据的描述性统计、可视化、特征计算、方程拟合等手段，去发现原始数据的结构与规律的一种数据分析方法。它可以直观地了解原始数据中各个变量或字段的数据范围、数据缺失情况（数据完整性）、有无异常值、变量分布情况，进而从总体上把握各个变量的真实情况，为后续的特征工程做准备。  

### 1.2 探索性数据分析与传统数据分析的区别
在传统的统计分析中，统计学家总是会对数据的分布特征做出先验地判断，假设样本服从某种分布，然后根据样本的特征进而去估计总体的特征。但是，在日常生活中，数据的分布往往并不是完美地符合假设的分布，这就会给我们的统计分析结果带来一定的偏差！  
探索性数据分析注重数据的真实分布，强调数据的可视化，使分析者能一目了然看出数据中隐含的规律，从而得到启发，以此帮助分析者找到适合数据的模型。“探索性”是指分析者对待解问题的理解会随着研究的深入不断变化。  

### 1.3 探索性数据分析的目的
- EDA价值主要在于熟悉了解整个数据集的基本情况（缺失值，异常值），对数据集进行验证是否可以进行接下来的机器学习或者深度学习建模  
- 了解变量间的相互关系、变量与预测值之间的存在关系  
- 为特征工程做准备  

## 2 探索性数据分析流程
### 2.1 数据集简介
数据集来源于 http://archive.ics.uci.edu/ 网站的德国评分卡数据](http://archive.ics.uci.edu/ml/datasets/Statlog+%28German+Credit+Data%29)，该数据共有1000个样本、20个变量，其中有7个为连续变量、13个为离散变量，变量介绍如下图所示。

![](https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5qQCASnmkak1VrdbdNPI40hSChttq5Bf1OboXApvef5Hg7K02Dl37hue5GqiabQG73pNibyE8Gj90EA/0?wx_fmt=png)

### 2.2 提出问题
数据分析的目标就是解决问题，提出感兴趣的或是以业务为导向的问题。这里提的问题如下：  
- 逾期样本占比多大？  
- 借款人的年龄、现有支票账户状态、历史信用记录、借款目的、储户状态、就业状态、性别婚姻状态、财产状况、房产状态、信用卡数量、工作状态是如何分布的？  
- 借款期数的分布情况，逾期样本的借款期数分布情况    

### 2.3 查看数据基本信息

**导入包**

```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt 
import sklearn
import seaborn as sns

%matplotlib inline
sns.set_style("darkgrid",{"font.sans-serif":['SongTi', 'Times New Roman']})   #这是方便seaborn绘图得时候得字体设置
plt.rcParams['savefig.dpi'] = 720 #图片像素
plt.rcParams['figure.dpi'] = 720 #分辨率
```

#### 2.3.1 读取数据
数据集中每一行数据用空格符号隔开，总共1000行21列

```python
df = pd.read_csv("./data/german.csv", header=None, delim_whitespace=True)
df.shape, df.head()

# output:
'''
((1000, 21),
     0   1    2    3     4    5    6   7    8     9   ...    11  12    13  \
 0  A11   6  A34  A43  1169  A65  A75   4  A93  A101  ...  A121  67  A143   
 1  A12  48  A32  A43  5951  A61  A73   2  A92  A101  ...  A121  22  A143   
 2  A14  12  A34  A46  2096  A61  A74   2  A93  A101  ...  A121  49  A143   
 3  A11  42  A32  A42  7882  A61  A74   2  A93  A103  ...  A122  45  A143   
 4  A11  24  A33  A40  4870  A61  A73   3  A93  A101  ...  A124  53  A143   
 
      14 15    16 17    18    19 20  
 0  A152  2  A173  1  A192  A201  1  
 1  A152  1  A173  1  A191  A201  2  
 2  A152  1  A172  2  A191  A201  1  
 3  A153  1  A173  2  A191  A201  1  
 4  A153  2  A173  2  A191  A201  2  
 
 [5 rows x 21 columns])
'''
```

#### 2.3.2 数据类型
可以看到数据集没有缺失值，有8列int型数据，13列字符型数据

```python
df.info()

#output:
'''
<class 'pandas.core.frame.DataFrame'>
RangeIndex: 1000 entries, 0 to 999
Data columns (total 21 columns):
 #   Column  Non-Null Count  Dtype 
---  ------  --------------  ----- 
 0   0       1000 non-null   object
 1   1       1000 non-null   int64 
 2   2       1000 non-null   object
 3   3       1000 non-null   object
 4   4       1000 non-null   int64 
 5   5       1000 non-null   object
 6   6       1000 non-null   object
 7   7       1000 non-null   int64 
 8   8       1000 non-null   object
 9   9       1000 non-null   object
 10  10      1000 non-null   int64 
 11  11      1000 non-null   object
 12  12      1000 non-null   int64 
 13  13      1000 non-null   object
 14  14      1000 non-null   object
 15  15      1000 non-null   int64 
 16  16      1000 non-null   object
 17  17      1000 non-null   int64 
 18  18      1000 non-null   object
 19  19      1000 non-null   object
 20  20      1000 non-null   int64 
dtypes: int64(8), object(13)
memory usage: 164.2+ KB
'''
```

#### 2.3.3 缺失值和单值特征
对于缺失值可以使用`isnull()`来查看，通常缺失值较多的特征可以剔除掉，可以设定一个阈值，缺失率大于阈值的特征剔除掉，缺失率小于阈值的特征可以进行填充或者直接把缺失值当做一种特征值来处理。
单值特征是指该列数据只有一个值，这种特征对模型来说是没什么用处的也应该剔除。

```python
df.isnull().sum()

#output:
'''
0     0
1     0
2     0
3     0
4     0
5     0
6     0
7     0
8     0
9     0
10    0
11    0
12    0
13    0
14    0
15    0
16    0
17    0
18    0
19    0
20    0
dtype: int64
'''
```

这里源数据集没有缺失值。

#### 2.3.4 添加变量名

```python
# 变量名
columns = ['status_account', 'duration', 'credit_history', 'purpose', 'amount','svaing_account', 'present_emp', 
           'income_rate', 'personal_status', 'other_debtors', 'residence_info', 'property', 'age', 'linst_plans',
           'housing', 'num_credits', 'job', 'dependents', 'telephone', 'foreign_worker', 'target']
df.columns = columns
# 将标签减1转化为0、1。其中，0表示好用户，没有发生违约；1表示坏用户，发生了违约。
df['target'] -= 1
```

#### 2.3.5 重复行

```python
df.duplicated().sum()

# output:
'''
0
'''
```

没有重复行。如果有重复，可使用`drop_duplicates()`删除重复行。

#### 2.3.6 区分出连续变量和离散变量

使用`select_dtypes()`函数可以根据`colmuns`的数据类型进行筛选。

```python
def category_continue_separation(df):
    numerival_cols = list(df.select_dtypes(include=['int', 'float', 'int32', 'float32', 'int64', 'float64']).columns.values)
    categorical_cols = [x for x in df.columns.values if x not in numerival_cols]
    return categorical_cols, numerival_cols
```

```python
categorical_cols, numerival_cols = category_continue_separation(df.iloc[:, :-1])
categorical_cols, numerival_cols

# output:
"""
(['status_account',
  'credit_history',
  'purpose',
  'svaing_account',
  'present_emp',
  'personal_status',
  'other_debtors',
  'property',
  'linst_plans',
  'housing',
  'job',
  'telephone',
  'foreign_worker'],
 ['duration',
  'amount',
  'income_rate',
  'residence_info',
  'age',
  'num_credits',
  'dependents'])
"""
```

13个类别特征，7个数值特征。

#### 2.3.7 异常值检测

这里采用单变量分析方法，通过绘制每个变量的箱线图，直观地感受样本的分布与异常值情况。

先看一下统计数据：

```python
df[numerival_cols].describe()

# output:
'''

duration	amount	income_rate	residence_info	age	num_credits	dependents
count	1000.000000	1000.000000	1000.000000	1000.000000	1000.000000	1000.000000	1000.000000
mean	20.903000	3271.258000	2.973000	2.845000	35.546000	1.407000	1.155000
std	12.058814	2822.736876	1.118715	1.103718	11.375469	0.577654	0.362086
min	4.000000	250.000000	1.000000	1.000000	19.000000	1.000000	1.000000
25%	12.000000	1365.500000	2.000000	2.000000	27.000000	1.000000	1.000000
50%	18.000000	2319.500000	3.000000	3.000000	33.000000	1.000000	1.000000
75%	24.000000	3972.250000	4.000000	4.000000	42.000000	2.000000	1.000000
max	72.000000	18424.000000	4.000000	4.000000	75.000000	4.000000	2.000000
'''
```

绘制盒图：

```python
fig = plt.figure(figsize=(20, 15))
ax = fig.subplots(2, 4)
for i in range(len(numerival_cols)):
    df.boxplot(column=numerival_cols[i], ax=ax[(i)//4, (i)%4], fontsize=13)
plt.show()
```

![](https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5ptJrUNuZjT5olag7FASvt3gH8NhLkMyzz6WqvpQcT8qZYibP6M8RTewqBwOO2rxxiafY7JHPlXeUBg/0?wx_fmt=png)

数据范围基本都正常，没有什么异常值。

## 3 问题分析

### 3.1 逾期样本占比多少

```python
plt.figure(figsize=(6, 6))
df['target'].value_counts().plot.pie(autopct='%.2f%%', title='label distribution')
plt.show()
```

<img src="https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5ptJrUNuZjT5olag7FASvt3OUiaKfm7TAePQFfb8Ym3T70dBJMukUyAzTKbe49hn8ehUDrsVlR4BFw/0?wx_fmt=png" style="zoom: 40%;" />

可以看到坏样本占比30%，这是一个非常高的比例。

### 3.2 借款人的年龄、现有支票账户状态、历史信用记录、借款目的、储户状态、就业状态、性别婚姻状态、财产状况、房产状态、信用卡数量、工作状态、电话号码注册情况、国外经历是如何分布的？

#### 3.2.1 年龄分布

```python
plt.figure(figsize=(16,12))
age_plot = sns.distplot(df['age'])
age_plot.set_title("Age Distribuition", fontsize=18)
age_plot.set_xlabel("age")
age_plot.set_ylabel("Probability", fontsize=15)
```

![](https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5ptJrUNuZjT5olag7FASvt3ibRZjzeOEGRFHMiaLzSBbicWxd7gEHNNReguKFvIydRdaYFJ0ZKKMKZSA/0?wx_fmt=png)

借款人最小的有19岁，最大的有75岁，主要集中于20到40岁之间。

这里可以对年龄进行分段， 0-20 Teenager， 21-40 Young， 41-55 Middle, 56-120 Old。

```python
bin_labels = ['Teenager','Young','Middle','Old']
bin_edges = [0,20,40,55,120]
df['age_group'] = pd.cut(df['age'], bin_edges, labels=bin_labels) 
```

```python
plt.figure(figsize=(6, 6))
df['age_group'].value_counts().plot.pie(autopct='%.2f%%', figsize=(6, 6),title='age distribution')
plt.show()
```

<img src="https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5ptJrUNuZjT5olag7FASvt371DPUPhwiaNbJfvTiatzzzRBFo0VKxfYKJo7dIpNFPldyyNU5UvETaAw/0?wx_fmt=png" style="zoom: 50%;" />

可以看到借款行为以21-40岁的年轻人为主(71%)，41-55岁的中年人次之(20.3%)，其次为56岁以上的老年人(7.1%)，20岁以下的少年最少(1.6%)。

#### 3.2.2 年龄段、现有支票账户状态、历史信用记录、储户状态、就业状态、性别婚姻状态、财产状况、房产状态、信用卡数量、工作状态、电话号码注册情况、国外经历分布

```python
def percentage_above_bar_relative_to_xgroup(ax):
    all_heights = [[p.get_height() for p in bars] for bars in ax.containers]
    for bars in ax.containers:
        for i, p in enumerate(bars):
            total = sum(xgroup[i] for xgroup in all_heights)
            percentage = '{}%'.format(round(p.get_height() / total * 100, 1))
            ax.annotate(percentage, (p.get_x() + p.get_width() / 2, p.get_height()), size=11, ha='center', va='bottom')
```

```python
fig, ax = plt.subplots(6, 2, figsize=(15, 30))
temp_cols = ['age_group', 'status_account', 'credit_history', 'svaing_account', 'present_emp', 'personal_status', 
             'property', 'housing', 'num_credits', 'job', 'telephone', 'foreign_worker']
for i, col in enumerate(temp_cols):
    sns.countplot(x=col, data=df, hue='target', ax=ax[i//2, i%2])
    percentage_above_bar_relative_to_xgroup(ax[i//2, i%2])
    ax[i//2, i%2].set(xlabel=col, ylabel='count')
plt.show()
```

<img src="https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5ptJrUNuZjT5olag7FASvt3miaXFZZClPHpRVZWjUYkzWp2ibs6yxtAibWOcPzFqxic8WGBQuxEF4Sl1Q/0?wx_fmt=png"  />

从图中可以得出如下结论：

- 20岁以下青少年违约比例最高，随着年龄的增长违约比例有降低趋势
- status_account取值为A11的借款人群体违约占比最高（49.27%），几乎有一半的借款人违约，A12次之，这两类客户违约风险较高。A14违约占比最低。
- 历史信用记录为A30的借款人违约占比最高（62.5%）,其次为A31（57.1%），这两种信用记录的借款人违约风险大
- 储户账户状态为A61和A62的借款人违约占比稍高于坏样本占总体的比例，其他几种状态的借款人违约风险较小
- 就业状态为A71和A72的借款人违约占比稍高于坏样本占总体的比例，其他几种状态的借款人违约风险较小
- 单身男性A93、已婚男性A94违约风险稍高于已婚女性A92和离异分局男性A91；缺少未婚女性A95的样本，可能未婚女性借款意愿较低。
- 从财产状况来看，随着不动产的减少坏样本数量占比也越多，可以推测无财产或财产状况不明的借款人风险更大。
- 从样本整体来看，有房的借款人A152占比最高，坏样本也最少；租房或者无住房的违约风险较高。
- 信用卡数量不同的各类借款人群体中，坏样本比例基本和整体差别不大
- 工作状态不同的各类借款人群体中，坏样本比例基本和整体差别不大
- 没有注册电话号码的借款人违约风险稍高于注册电话号码的，但差别不大。
- 绝大部分借款人都有国外工作经历，且违约风险显著高于无国外工作经历的借款人。

### 3.3 借款期数的分布情况，逾期样本的借款期数分布情况

借款期数的分布情况：

```python
fig = plt.figure(figsize=(18, 12))
df['duration'].value_counts().sort_index().plot.bar()
```

![](https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5ptJrUNuZjT5olag7FASvt350O7b06rxOgRE4LmqVFucSwUlqNWH4ndGMsLw6ic74QGkyaib1Nzyn4Q/0?wx_fmt=png)

从数据上来看，借款期数主要集中于半年期、一年期、一年半期、两年期、3年期等时间是半年的整数倍的期数，这也与借款平台的产品规划有关

逾期样本的借款期数分布情况：

```python
fig = plt.figure(figsize=(18, 12))
df[df['target'] == 1]['duration'].value_counts().sort_index().plot.bar()
```

![](https://mmbiz.qpic.cn/mmbiz_png/GJUG0H1sS5ptJrUNuZjT5olag7FASvt3MztvibfatQA4uOdaucsfHBKqsibYKWT26tOfs3HicmW5Qzeb52CJAe4Yw/0?wx_fmt=png)

逾期样本的期数分布情况也与总体接近，主要集中于半年期、一年期、一年半期、两年期、3年期等时间是半年的整数倍的期数

## 4 生成分析报告

pandas_profiling基于pandas的DataFrame数据类型，可以简单快速地进行探索性数据分析。

对于数据集的每一列，pandas_profiling会提供以下统计信息：

- 概要：数据类型，唯一值，缺失值，内存大小
- 分位数统计：最小值、最大值、中位数、Q1、Q3、最大值，值域，四分位
- 描述性统计：均值、众数、标准差、绝对中位差、变异系数、峰值、偏度系数
- 最频繁出现的值，直方图/柱状图
- 相关性分析可视化：突出强相关的变量，Spearman, Pearson矩阵相关性色阶图

并且这个报告可以导出为HTML，非常方便查看。

```python
import pandas_profiling

pfr = pandas_profiling.ProfileReport(df)
pfr.to_file("./GermanPFR.html")
```

